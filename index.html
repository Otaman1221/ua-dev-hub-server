import datetime
import threading
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QListWidget,
    QListWidgetItem, QLineEdit, QPushButton, QLabel, QFrame
)
from PySide6.QtCore import Qt, Signal

class ChatBubble(QFrame):
    def __init__(self, text, time, user, is_me=False, reply_to=None):
        super().__init__()
        layout = QVBoxLayout(self)
        bg_color = "#3d59a1" if is_me else "#24283b"
        content_layout = QVBoxLayout()

        if reply_to:
            reply_box = QLabel(f"↪️ {reply_to[:40]}...")
            reply_box.setStyleSheet("color: #7aa2f7; font-size: 10px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 5px;")
            content_layout.addWidget(reply_box)

        if not is_me:
            user_lbl = QLabel(user)
            user_lbl.setStyleSheet("color: #bb9af7; font-size: 11px; font-weight: bold;")
            content_layout.addWidget(user_lbl)

        msg_lbl = QLabel(text)
        msg_lbl.setWordWrap(True)
        msg_lbl.setStyleSheet("color: #c0caf5; font-size: 14px; border: none; background: transparent;")

        time_lbl = QLabel(time)
        time_lbl.setStyleSheet("color: #565f89; font-size: 10px;")
        time_lbl.setAlignment(Qt.AlignRight)

        content_layout.addWidget(msg_lbl)
        content_layout.addWidget(time_lbl)
        self.setStyleSheet(f"background-color: {bg_color}; border-radius: 12px; padding: 8px;")
        layout.addLayout(content_layout)
        self.setFixedWidth(380)

class TeamMessenger(QWidget):
    def __init__(self, engine, current_user):
        super().__init__()
        self.engine = engine
        self.current_user = current_user
        self.reply_data = None
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 5, 10, 10)

        self.chat_list = QListWidget()
        self.chat_list.setStyleSheet("background: transparent; border: none; outline: none;")
        self.chat_list.setSpacing(10)
        self.chat_list.itemClicked.connect(self.prepare_reply)
        layout.addWidget(self.chat_list)

        self.reply_bar = QFrame()
        self.reply_bar.setVisible(False)
        self.reply_bar.setStyleSheet("background: #16161e; border-left: 3px solid #7aa2f7;")
        rb_layout = QHBoxLayout(self.reply_bar)
        self.reply_label = QLabel("")
        self.reply_label.setStyleSheet("color: #7aa2f7; font-size: 11px;")
        close_btn = QPushButton("✕")
        close_btn.setFixedSize(20, 20)
        close_btn.clicked.connect(self.cancel_reply)
        rb_layout.addWidget(self.reply_label)
        rb_layout.addWidget(close_btn)
        layout.addWidget(self.reply_bar)

        input_container = QHBoxLayout()
        self.msg_input = QLineEdit()
        self.msg_input.setPlaceholderText("Напишіть повідомлення...")
        self.msg_input.setStyleSheet("background: #24283b; color: white; padding: 12px; border-radius: 20px;")
        self.msg_input.returnPressed.connect(self.send_msg)

        send_btn = QPushButton("➤")
        send_btn.setFixedSize(45, 45)
        send_btn.setStyleSheet("background: #7aa2f7; color: #1a1b26; border-radius: 22px;")
        send_btn.clicked.connect(self.send_msg)

        input_container.addWidget(self.msg_input)
        input_container.addWidget(send_btn)
        layout.addLayout(input_container)

    def clear_ui_chat(self):
        self.chat_list.clear()

    def add_single_message(self, m, is_me=False):
        item = QListWidgetItem(self.chat_list)
        bubble = ChatBubble(m['text'], m['time'], m['user'], is_me, m.get('reply_to'))
        item.setSizeHint(bubble.sizeHint())
        self.chat_list.addItem(item)
        self.chat_list.setItemWidget(item, bubble)
        if is_me: item.setTextAlignment(Qt.AlignRight)
        self.chat_list.scrollToBottom()

    def send_msg(self):
        text = self.msg_input.text().strip()
        if not text: return
        msg = {
            "user": self.current_user, 
            "text": text, 
            "time": datetime.datetime.now().strftime("%H:%M"),
            "reply_to": self.reply_data
        }
        self.add_single_message(msg, is_me=True)
        self.msg_input.clear()
        self.cancel_reply()
        threading.Thread(target=self._async_push, args=(msg,), daemon=True).start()

    def _async_push(self, msg):
        try:
            data, sha = self.engine.get_file_data("db/chat.json")
            data.append(msg)
            self.engine.push_file_data("db/chat.json", data, sha)
        except: pass

    def prepare_reply(self, item):
        widget = self.chat_list.itemWidget(item)
        labels = widget.findChildren(QLabel)
        msg_text = labels[1].text() if len(labels) > 1 else labels[0].text()
        self.reply_data = msg_text
        self.reply_label.setText(f"Відповідь на: {msg_text[:40]}...")
        self.reply_bar.setVisible(True)
        self.msg_input.setFocus()

    def cancel_reply(self):
        self.reply_data = None
        self.reply_bar.setVisible(False)